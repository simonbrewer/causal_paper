---
title: "Counterfactual Example"
author: "Simon Brewer"
date: "5/25/2023"
output: html_document
---

```{r setup, include=FALSE}
set.seed(123)
knitr::opts_chunk$set(echo = TRUE)
```


Examples taken from chapter 8 of The Book Of Why (Pearl, 2019)

## Libraries and whatnot

```{r warning=FALSE, message=FALSE}
library(tidyverse)
# library(broom)
library(patchwork)
library(scales)
library(dagitty)
library(ggdag)
library(latex2exp)  # Easily convert LaTeX into arcane plotmath expressions
library(ggtext)     # Use markdown in ggplot labels

# Create a cleaner serifed theme to use throughout
theme_do_calc <- function() {
  theme_dag(base_family = "Times New Roman") +
    theme(plot.title = element_text(size = rel(1.5)),
          plot.subtitle = element_markdown())
}

# Make all geom_dag_text() layers use these settings automatically
update_geom_defaults(ggdag:::GeomDagText, list(family = "Times New Roman", 
                                               fontface = "bold",
                                               color = "black"))
```

## Salary example

Data are

- `EX`: number of years of experience
- `ED`: Education level (0 = BS; 1 = MS; 2 = PhD)
- `S`: Salary in `$`


### Directed acyclic graph

The graph is set up as a fork, with education impacting both experience and salary:

```{r}
dag1 <- dagify(EX ~ ED,
               S ~ EX + ED,
               coords = list(x = c(ED = 1, EX = 2, S = 3),
                             y = c(ED = 1, EX = 2, S = 1)),
               exposure = "EX",
               outcome = "S")

ggdag(dag1) +
  theme_dag()
```

Equations are:

$$EX = f(ED)$$
$$S = f(ED, EX)$$

For a counterfactual analysis, we extend this to include unobserved variables ($U_x$):

```{r}
pcm_dag <- dagify(ED ~ U_ED,
               EX ~ ED + U_EX,
               S ~ EX + ED + U_S,
               coords = list(x = c(ED = 1, EX = 2, S = 3,
                                   U_ED = 0.5, U_EX = 1.5, U_S = 3.5),
                             y = c(ED = 1, EX = 2, S = 1,
                                   U_ED = 1, U_EX = 2, U_S = 1)),
               exposure = "EX",
               outcome = "S", latent = c("U_ED", "U_EX", "U_S"))

ggdag(pcm_dag) +
  theme_dag()
```

Equations are:

$$ED = f(U_{ED})$$
$$EX = f(ED, U_{EX})$$

$$S = f(ED, EX, U_{S})$$
From Pearl: "We know these variables exist (e.g. Alice is a friend of the company's president) but they are too diverse and too numerous to incorporate explicitly..."

## Data

We start with two equations

\[
ED = U_{ED} = [0,1,2]
\]

\[
EX= 10 - 4 \times ED + U_{EX}
\]

\[
S=65,000 + 2,500 \times EX + 5,000 \times ED + U_{S}
\]

### Simulated data

1. `ED`:

```{r}
n = 1000
ED = sample(c(0,1,2), size = n, replace = TRUE,
            prob = c(0.6, 0.3, 0.1))

table(ED)
```

2. `EX`:

```{r}
U_EX = rpois(n, lambda = 2) - 1
EX = 10 - 4 * ED + U_EX
table(EX)
```

>   #sample size
> n <- 10
>   #regression coefficients
> beta0 <- 1
> beta1 <- 0.2
>   #generate covariate values
> x <- runif(n=n, min=0, max=1.5)
>   #compute mu's
> mu <- exp(beta0 + beta1 * x)
>   #generate Y-values
> y <- rpois(n=n, lambda=mu)
>   #data set
> data <- data.frame(y=y, x=x)
> data