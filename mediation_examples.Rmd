---
title: "Causal Mediation Examples"
author: "Simon Brewer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
set.seed(123)
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries and whatnot

```{r warning=FALSE, message=FALSE}
library(tidyverse)
# library(broom)
library(patchwork)
library(scales)
library(dagitty)
library(ggdag)
library(latex2exp)  # Easily convert LaTeX into arcane plotmath expressions
library(ggtext)     # Use markdown in ggplot labels

# Create a cleaner serifed theme to use throughout
theme_do_calc <- function() {
  theme_dag(base_family = "Times New Roman") +
    theme(plot.title = element_text(size = rel(1.5)),
          plot.subtitle = element_markdown())
}

# Make all geom_dag_text() layers use these settings automatically
update_geom_defaults(ggdag:::GeomDagText, list(family = "Times New Roman", 
                                               fontface = "bold",
                                               color = "black"))
```

## Examples

In all the examples that follow, we are trying to estimate a causal relationship between `x` and `y`. 

## Example 1: Single mediator

This represents an indirect path from intervention to outcome via a mediator (`x` &rarr; `z` &rarr; `y`), as well as a direct path (`x` &rarr; `y`)

```{r}
med_dag <- dagify(z ~ x,
                    y ~ x + z,
                    coords = list(x = c(x = 1, y = 3, z = 2),
                                  y = c(x = 1, y = 1, z = 2)),
                    exposure = "x",
                    outcome = "y")

ggdag(med_dag) +
  theme_dag()
```

### Simulated data

- $x \sim N(5, 1)$
- $z = \beta_{xz} \times x + e$
- $y = \beta_{xy} \times x + \beta_{zy} \times z + e$

```{r}
n <- 1000

b_xz = 4
b_xy = 2
b_zy = -1.5

x <- rnorm(n, 5, 1)
z <- x * b_xz + rnorm(n, 0, 2)
y <- x * b_xy + z * b_zy + rnorm(n, 0, 2)
df <- data.frame(x, y, z)
```

```{r}
pairs(df)
```

### Mediation

#### Step 1: total effect

```{r}
fit1 <- lm(y ~ x, df)
summary(fit1)
```

The total effect is given by the product of the coefficients of the indirect path plus the coefficient of the direct path: $TE = \beta_{xz} \times \beta_{zy} + \beta_{xy}$

The expected value for this is `r b_xz` times `r b_zy` plus `r b_xy` = `r b_xz * b_zy + b_xy`, and we obtain a value of `r round(coef(fit1)['x'], 2)`. 
