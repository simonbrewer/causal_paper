---
title: "WNAI model"
author: "Simon Brewer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
set.seed(1234)
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries and whatnot

```{r warning=FALSE, message=FALSE}
library(lavaan)
library(lavaanPlot)
library(dagitty)
library(ggdag)
```

## Full DAG

```{r}
wnai_dag <- dagify(density ~ temp + precip,
                   agri  ~ density + temp + precip,
                    plant ~ temp + precip + density + agri,
                    animal ~ temp + precip + density + plant,
                    coords = list(x = c(temp = 1, precip = 1, 
                                        density = 2, plant = 2.5,
                                        agri = 3,
                                        animal = 4),
                                  y = c(temp = 2, precip = 3, 
                                        density = 1, plant = 4,
                                        agri = 1,
                                        animal = 2.5)))

ggdag(wnai_dag) +
  theme_dag()
```

## Data

```{r}
dat <- read.csv("~/Dropbox/DB Docs/codding/causal_paper/data/WNAI-DPLACE_Causal_060223_v2.csv")
```

```{r}
df <- data.frame(precip = dat$MonthlyMeanPrecip,
                   temp = dat$AnnualMeanTemperature,
                   density = dat$WNAI288_PopDensityAve,
                   agri = dat$WNAI189_Ag01,
                   animal = dat$LandMammal_Richness,
                   plant = dat$Plant_Richness
                   )
```

```{r}
skimr::skim(df)
```

```{r}
fit <- lm(animal ~ density + precip + temp + plant + agri, df)
car::vif(fit)
```

## Model 1: Plants

Causal link to be tested: `plants ~ density`. 

Let's check the adjustment set for this. There are two forks (via `precip` and `temp`), which create backdoor paths that need to be controlled for. In addition, `agri` forms a chain through to plant richness and will need to be controlled for

```{r}
ggdag_adjustment_set(wnai_dag, 
                     exposure = "density",
                     outcome = "plant",
                     shadow = TRUE) +
  theme_dag()
```

## Model 2: Animals

Causal link to be tested: `animal ~ density`. 

Let's check the adjustment set for this. There are two forks (via `precip` and `temp`), which create backdoor paths that need to be controlled for. In addition, `agri` forms a chain through to plant richness and will need to be controlled for

```{r}
ggdag_adjustment_set(wnai_dag, 
                     exposure = "density",
                     outcome = "animal",
                     shadow = TRUE) +
  theme_dag()
```

### DAG

```{r}
df2 <- scale(df)
model <- "
  density ~ b_td * temp + b_pd * precip
  agri ~ b_tag * temp + b_pag * precip + b_dag * density
  plant ~ b_tpl * temp + b_ppl * precip + b_dpl * density + b_agpl * agri
  animal ~ b_tan * temp + b_pan * precip + b_dan * density + b_plan * plant
  ind_eff1 := (b_dag * b_agpl * b_plan)
  ind_eff2 := (b_dpl * b_plan)
  total := b_dan + ind_eff1 + ind_eff2
"
semfit <- lavaan::sem(model = model, data = df2)
lavaanPlot(model = semfit)
```

```{r}
summary(semfit)
```